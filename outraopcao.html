<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Medusa Braids</title>

<style>
:root {
  --purple:#7a39f7;
  --bg:#f5f5f5;
  --surface:#ffffff;
  --radius:12px;
}

body {
  margin:0;
  font-family:'Poppins', sans-serif;
  background: var(--bg);
  color:#222;
}

.container {
  max-width:900px;
  margin:auto;
  padding:20px;
}

h1,h2,h3 { margin:10px 0; }

input, select, button {
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
}

button {
  background: var(--purple);
  color:#fff;
  border:none;
  cursor:pointer;
}

button:hover { opacity:0.9; }

.hidden { display:none; }

#loginPanel, #agendaPanel, #adminPanel {
  background: var(--surface);
  padding:20px;
  border-radius: var(--radius);
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  margin-top:20px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
}

th {
  background: var(--purple);
  color:white;
}
</style>
</head>

<body>
<div class="container">
  <h1>Agenda Medusa Braids</h1>

  <!-- LOGIN -->
  <div id="loginPanel">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Senha"><br><br>
    <button id="loginBtn">Entrar</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <!-- CLIENTE -->
  <div id="agendaPanel" class="hidden">
    <h2>Agendamento</h2>
    <p>Trança: <strong id="selectedBraid">—</strong></p>

    <label>Data:</label><br>
    <input type="date" id="date"><br><br>

    <label>Horário:</label><br>
    <select id="time"></select><br><br>

    <button id="bookBtn">Agendar</button>

    <h3>Seus agendamentos</h3>
    <ul id="myAppointments"></ul>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" class="hidden">
    <h2>Painel Admin</h2>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Trança</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="appointmentsTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ===========================
// SUPABASE
// ===========================
const supabase = createClient(
  'https://SEU-SUPABASE-URL',
  'SUA-CHAVE-PUBLICA'
);

const WHATSAPP_NUMBER = '5599999999999';

// ===========================
// ELEMENTOS
// ===========================
const loginPanel = document.getElementById('loginPanel');
const agendaPanel = document.getElementById('agendaPanel');
const adminPanel = document.getElementById('adminPanel');

const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const loginMsg = document.getElementById('loginMsg');

const dateInput = document.getElementById('date');
const timeSelect = document.getElementById('time');

const myAppointments = document.getElementById('myAppointments');
const appointmentsTable = document.getElementById('appointmentsTable');
const selectedBraidSpan = document.getElementById('selectedBraid');

const loginBtn = document.getElementById('loginBtn');
const bookBtn = document.getElementById('bookBtn');

// ===========================
let currentUser = null;
let selectedBraid =
  new URLSearchParams(window.location.search).get('braid') || '—';

selectedBraidSpan.innerText = selectedBraid;

// ===========================
// EVENTOS
// ===========================
loginBtn.addEventListener('click', login);
bookBtn.addEventListener('click', bookAppointment);
dateInput.addEventListener('change', loadAvailableTimes);

// ===========================
// LOGIN
// ===========================
async function login(){
  loginMsg.innerText = '';

  const { data, error } =
    await supabase.auth.signInWithPassword({
      email: emailInput.value,
      password: passwordInput.value
    });

  if(error){
    loginMsg.innerText = error.message;
    return;
  }

  currentUser = data.user;
  const role = currentUser.user_metadata?.role || 'cliente';

  loginPanel.classList.add('hidden');

  if(role === 'adm'){
    adminPanel.classList.remove('hidden');
    loadAllAppointments();
  } else {
    agendaPanel.classList.remove('hidden');
    loadMyAppointments();
  }
}

// ===========================
// BLOQUEIA DOMINGO E SEGUNDA
// ===========================
function isBlockedDay(dateStr){
  const day = new Date(dateStr + 'T00:00').getDay();
  return day === 0 || day === 1;
}

// ===========================
// HORÁRIOS FIXOS
// ===========================
function loadAvailableTimes(){
  timeSelect.innerHTML = '';

  if(!dateInput.value) return;

  if(isBlockedDay(dateInput.value)){
    alert('Não atendemos aos domingos e segundas.');
    dateInput.value = '';
    return;
  }

  const start = 8 * 60;
  const end = 18 * 60;
  const lunchStart = 12 * 60 + 30;
  const lunchEnd = 14 * 60;

  for(let min = start; min < end; min += 30){
    if(min >= lunchStart && min < lunchEnd) continue;

    const h = String(Math.floor(min / 60)).padStart(2,'0');
    const m = String(min % 60).padStart(2,'0');

    const opt = document.createElement('option');
    opt.value = `${h}:${m}`;
    opt.textContent = `${h}:${m}`;
    timeSelect.appendChild(opt);
  }
}

// ===========================
// AGENDAMENTO + WHATSAPP
// ===========================
async function bookAppointment(){
  if(!dateInput.value || !timeSelect.value){
    alert('Selecione data e horário');
    return;
  }

  await supabase.from('appointments').insert({
    user_id: currentUser.id,
    braid_type: selectedBraid,
    date: dateInput.value,
    time: timeSelect.value,
    status: 'agendado'
  });

  const nome =
    currentUser.user_metadata?.name || currentUser.email;

  const mensagem =
`Olá, me chamo ${nome}.
Gostaria de saber se o horário ${timeSelect.value} do dia ${dateInput.value}
para ${selectedBraid} está disponível.`;

  window.open(
    `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensagem)}`,
    '_blank'
  );

  alert('Agendamento confirmado!');
  loadMyAppointments();
}

// ===========================
// CLIENTE
// ===========================
async function loadMyAppointments(){
  const { data } = await supabase
    .from('appointments')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('date');

  myAppointments.innerHTML = '';
  data.forEach(a=>{
    myAppointments.innerHTML +=
      `<li>${a.braid_type} — ${a.date} ${a.time}</li>`;
  });
}

// ===========================
// ADMIN
// ===========================
async function loadAllAppointments(){
  const { data } = await supabase
    .from('appointments')
    .select('*, users(email, user_metadata)')
    .order('date');

  appointmentsTable.innerHTML = '';

  data.forEach(a=>{
    const nome =
      a.users.user_metadata?.name || a.users.email;

    appointmentsTable.innerHTML += `
      <tr>
        <td>${nome}</td>
        <td>${a.braid_type}</td>
        <td>${a.date}</td>
        <td>${a.time}</td>
        <td>
          <button onclick="deleteAppointment(${a.id})">
            Excluir
          </button>
        </td>
      </tr>
    `;
  });
}

async function deleteAppointment(id){
  if(confirm('Excluir agendamento?')){
    await supabase.from('appointments').delete().eq('id', id);
    loadAllAppointments();
  }
}
</script>

</body>
</html>
